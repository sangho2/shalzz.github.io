<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
  DLNA&#x2F;UPNP casting support in VLC - Part 2
</title>

    
    <meta name="description" content="DLNA renderers, mainly TVâ€™s are DLNA certified devices that are able to play
any media from the local network and is built upon the UPnP A&#x2F;V Architecture technology.
This allows you to cast any video or audio from any other device to your connected TV.
">

    
        <meta name="keywords" content="web, android, technology, docker, javascript, java, python, blog, computer engineering, shaleen jain, shalzz, shaleen, jain, C/C++, rust, C, C++, GO-lang, upnp, dlna, upnp/dlna, dlna/upnp, vlc, casting, stream, media, media renderer, renderer, dlna renderer">
    


    
        <meta name="author" content="Shaleen Jain">

        <link rel="author" href="https:&#x2F;&#x2F;twitter.com&#x2F;shalzzj">
        
            <link href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;blog&#x2F;vlc-dlna-support-2&#x2F;" rel="canonical">
        
         <link rel="alternate" type="application/atom+xml" title="RSS" href="https://shaleenjain.com/atom.xml">
    

    
    
        <meta name="twitter:site" content="@shalzzj">
        <meta name="twitter:creator" content="@shalzzj">

        <meta property="og:type" content="article">
        
            <meta property="og:url" content="https:&#x2F;&#x2F;shaleenjain.com&#x2F;blog&#x2F;vlc-dlna-support-2&#x2F;">
        

        
        <meta property="og:description" content="Personal and technical musings">
        
    
    <meta name="twitter:title" content="DLNA&#x2F;UPNP casting support in VLC - Part 2 &mdash; Shaleen Jain">
    <meta property="og:title" content="DLNA&#x2F;UPNP casting support in VLC - Part 2">


    
    


    
        <link rel="apple-touch-icon" sizes="180x180" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;favicon-16x16.png">
        <link rel="manifest" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;manifest.json">
        <link rel="mask-icon" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;safari-pinned-tab.svg">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;favicon.ico">
        <meta name="msapplication-config" content="https:&#x2F;&#x2F;shaleenjain.com&#x2F;icons&#x2F;browserconfig.xml">
        <meta name="theme-color" content="#ffffff">
    

    

    
        <style>
            /*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:"sans-serif";-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:0px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}html{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}.image-row{display:flex;flex-flow:row wrap;align-items:center;padding:0 4px}.image-column{flex:50%;max-width:50%;padding:0 4px;border-radius:8px;width:100%;height:auto}@media screen and (max-width: 42em){.image-column{flex:100%;max-width:100%}}.text-center{text-align:center}.text-right{text-align:right}.fa-social-icons{font-size:2rem;margin-top:-1rem}.fa-social-icons a{border:0;margin-right:0.1rem}.fa-social-icons a:last-child{margin-right:0}.masthead,.content,.footer{max-width:42em;margin-left:auto;margin-right:auto}.masthead:after,.post:after,.related:after,.recent:after,.page:after,.comments:after,.index:after{display:block;content:"";width:150px;height:1px;margin:2rem auto;background-color:#c4c4c4}.related .related-title,.related .recent-title,.recent .related-title,.recent .recent-title{margin-top:0}.masthead{margin-bottom:2rem}.masthead a{color:#111}.masthead .masthead-title{margin:0;padding:0}.masthead .masthead-title a{text-decoration:none;border:0}@media (min-width: 42em){.masthead .masthead-title{float:left}}.masthead .masthead-nav{display:inline-block;padding-left:0;margin-bottom:0}.masthead .masthead-nav a{text-decoration:none;border:0}.masthead .masthead-nav a+a{margin-left:0.6rem}@media (min-width: 42em){.masthead{padding-top:1rem;text-align:right}}.footer{margin-bottom:1rem;text-align:center}.footer a[rel="license"]:first-child{display:inline-block;margin:0;padding:0;border:0;text-decoration:none}.footer .icon-square{color:transparent}.footer .icon-square:hover{color:#252525}.footer .fa-stack-1x{color:black}.footer p>span{font-size:110%}.footer p>span a{padding:2px;border:0}.footer p>span i:hover{color:white}.footer p p:last-child{margin-bottom:0}.posts{padding-bottom:1rem}.posts .posts-item{margin-bottom:1rem}@media (min-width: 42em){.posts .posts-item{margin-bottom:0.2rem}}.posts a{border:0}.posts time{display:block;color:#848484}@media (min-width: 42em){.posts time{margin-top:2px;float:right}}.next,.previous{font-weight:600;font-size:20px;transition:transform 0.3s ease-out}.next{float:right}.next:hover{transform:translateX(4px)}.previous{float:left}.previous:hover{transform:translateX(-4px)}html,body{margin:0}html{font-family:"Lora","sans-serif";font-size:18px;line-height:1.6}@media (min-width: 42em){html{font-size:20px}}body{padding:2rem 1.5rem;color:#444;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#afd700;text-decoration:none;border-bottom:1px solid #afd700}a:hover,a:focus{background-color:#afd700;color:white}a strong{color:inherit}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;font-size:85%;border:1px solid #c4c4c4;border-collapse:collapse}.js-file-line-container td{border:none}td,th{padding:.25rem .5rem;border:1px solid #c4c4c4}th{text-align:left}tbody tr:nth-child(even) td,tbody tr:nth-child(even) th{background-color:#fff}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#fafafa}

        </style>
    

    
      <style>
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: italic;
          font-weight: 400;
          font-display: swap;
          src: url(https://shaleenjain.com/fonts/0QI8MX1D_JOuMw_hLdO6T2wV9KnW-MoFoq92nA.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url(https://shaleenjain.com/fonts/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url(https://shaleenjain.com/fonts/0QI6MX1D_JOuGQbT0gvTJPa787z5vBJBkq0.woff2) format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
      </style>
    
  </head>

  <body>
    
        <link rel="stylesheet" href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;style.css">
    

    
        <header class="masthead">
          <h3 class="masthead-title">
            <a href="https:&#x2F;&#x2F;shaleenjain.com">Shaleen Jain</a>
          </h3>
          <nav class="masthead-nav">
            
            <a href="&#x2F;blog" class="nav-item">Blog</a>
            
          </nav>
        </header>
    


    <main class="content">
        

<article class="post">
  <header class="post-header">
    <time datetime="2019-01-12" class="post-date">
        12 Jan 2019
    </time>
        
        <small>
            Â· 
    <span class="reading-time" title="Estimated read time">
      
        3 min read
      
    </span>

        </small>
    <h1 class="post-title">DLNA&#x2F;UPNP casting support in VLC - Part 2</h1>
  </header>

  <p>DLNA renderers, mainly TVâ€™s are DLNA certified devices that are able to play
any media from the local network and is built upon the UPnP A/V Architecture technology.
This allows you to cast any video or audio from any other device to your connected TV.</p>
<span id="continue-reading"></span>
    <details open id = "toc-inline">
        <summary><b>Table of Contents</b></summary>
        <ul>
            <li>
                <a href="#discoverying-devices">Discoverying Devices</a>
                
            </li><li>
                <a href="#casting-to-the-device">Casting to the Device</a>
                
            </li><li>
                <a href="#device-media-formats">Device Media Formats</a>
                
            </li><li>
                <a href="#future">Future</a>
                <ul>
                    <li>
                        <a href="#demux-filter">Demux Filter</a>
                    </li><li>
                        <a href="#dlna-v1-5">DLNA v1.5</a>
                    </li>
                </ul>
            </li><li>
                <a href="#code">Code</a>
                
            </li><li>
                <a href="#release">Release</a>
                
            </li>
        </ul>
    </details>

<h2 id="discoverying-devices"><a class="zola-anchor" href="#discoverying-devices" aria-label="Anchor link for: discoverying-devices">ðŸ”—</a>
Discoverying Devices</h2>
<p>The next step in adding DLNA support was adding a <code>renderer_discovery</code>
module responsible for searching and adding devices that are Media Renderers i.e.
capable of playing a video/audio stream that we may cast to it.</p>
<p>To do that we use the <code>libupnp</code> library to find the devices and call the
VLC <code>vlc_renderer_item_new()</code> function for each device with relevant information
so that they can be show to the user in a menu and then select which device to cast to.</p>
<p>Someone had partially done this before me but not yet merged, partly due to the problem
I explained and solved in the previous post of this series. After adapting that
patch we were now able to discover and list any DLNA renderers available
on the same network.</p>
<img src="https:&#x2F;&#x2F;shaleenjain.com&#x2F;processed_images&#x2F;75db85a38c0c447f00.jpg"  />
<h2 id="casting-to-the-device"><a class="zola-anchor" href="#casting-to-the-device" aria-label="Anchor link for: casting-to-the-device">ðŸ”—</a>
Casting to the Device</h2>
<p>Now to actually be able to cast to a device we need to create a <code>stream_out</code>
VLC module with http as the transport method. Much of that logic is similar to
how chromecast creates a <code>stream_out</code> except that we use UPnP Actions represented
as SOAP requests instead of the horror that is Google's protobuf to talk to the device.</p>
<p>After going through the DLNA guidelines and the UPnP AV spec, I added functions
that called the actions required to talk to any DLNA device implementing the AVTransport Service
and we had a working implementation of VLC acting as a UPnP control point that
was able to cast to almost all DLNA renderers.</p>
<p>I say almost all because legacy DLNA renderers (below DLNA v1.5) and renderers
not implementing the <code>AVTransport::SetAVTransportURI</code> action are not yet supported.</p>
<h2 id="device-media-formats"><a class="zola-anchor" href="#device-media-formats" aria-label="Anchor link for: device-media-formats">ðŸ”—</a>
Device Media Formats</h2>
<p>Having a working tranport is still half of story, another important aspect of casting is to make
sure the device is able to decode the file that you are trying to play.
To solve this I had to call the <code>ConnectionManager::GetProtocolInfo()</code> action
to get a CSV list of all the Media formats supported by the device, maintain
a manual list of all possible Media format profiles defined by DLNA.org and others within VLC,
find a profile that best describes the file the user is trying to play and then
compare that profile to the device profiles to make sure if it can play it.</p>
<p>And if a device does not support the profile of the file we are trying to play
then we transcode the file to a format that the device supports, on the fly,
and stream it to the device.</p>
<p>As you can imagine this is quite an involved process more so with the transcoding
since we had to make sure the transcoding will work in a reasonable amount of time
on every platform VLC is run i.e. on Linux, Windows, MacOS, iOS and android
each of which has different platform APIs and SoCs/Processors
and hence took up majority of my time.</p>
<h2 id="future"><a class="zola-anchor" href="#future" aria-label="Anchor link for: future">ðŸ”—</a>
Future</h2>
<p>There are still a few things left to add for a seamless experience with DLNA casting
in VLC.</p>
<h3 id="demux-filter"><a class="zola-anchor" href="#demux-filter" aria-label="Anchor link for: demux-filter">ðŸ”—</a>
Demux Filter</h3>
<p>Due to the nature of VLC's module system and its media processing pipeline, <code>stream_out</code>
modules cannot control the rate at which a video is decoded and sent out for display.
So things like pause, fast-forward and track sync between VLC and the DLNA device doesn't
work properly yet.</p>
<p>There's a workaround to use <code>demux_filter</code> to control the pacing between the <code>demux</code>
and the <code>access_out</code> module using an IPC mechanisuim between the two modules,
even though they both run in the same process.</p>
<h3 id="dlna-v1-5"><a class="zola-anchor" href="#dlna-v1-5" aria-label="Anchor link for: dlna-v1-5">ðŸ”—</a>
DLNA v1.5</h3>
<p>DLNA v1.5 is a legacy DLNA spec version that has very strict requirements and cannot
easily play any supported media from the cloud. These requirements were removed
in later versions of the DLNA spec.</p>
<p>To support DLNA v1.5 Media Renderers (many old Samsung and Sony TVs) 
we need a DLNA v1.5 compliant HTTP server with the appropriate DLNA specific headers.
This is related to the <code>demux_filter</code> and can be easily implemented once we have that.</p>
<h2 id="code"><a class="zola-anchor" href="#code" aria-label="Anchor link for: code">ðŸ”—</a>
Code</h2>
<p>The merged commits can be found here:</p>
<ol>
<li><a href="http://git.videolan.org/?p=vlc.git;a=commit;h=0d89fe3fd7d27d7c3f349bb46a915dbae65c02f8">upnp: add renderer discoverer</a></li>
<li><a href="http://git.videolan.org/?p=vlc.git;a=commit;h=ec61edc0d0292ab37bb1dbafb23a8aed49e966bb">chromecast: refactor out encoder option functions</a></li>
<li><a href="http://git.videolan.org/?p=vlc.git;a=commit;h=7da4464ca093604f2a507e3b39330fed17838e62">dlna: add a DLNA stream out</a></li>
<li><a href="http://git.videolan.org/?p=vlc.git;a=commit;h=0a34ce334a7c8b2d3926148be30f5b69fd253e41">dlna: add GetProtocolInfo action</a></li>
<li><a href="http://git.videolan.org/?p=vlc.git;a=commit;h=b671d3b3270790fd11aa3bc76cfe42f75ca25c52">dlna: add PrepareForConnection action</a></li>
</ol>
<h2 id="release"><a class="zola-anchor" href="#release" aria-label="Anchor link for: release">ðŸ”—</a>
Release</h2>
<p>You can start casting to DLNA compliant devices using the next VLC 4.0 release
or the latest nightly<sup class="footnote-reference"><a href="#fn-warn">1</a></sup>
releases for Windows, MacOS and Linux.</p>
<div class="footnote-definition" id="fn-warn"><sup class="footnote-definition-label">1</sup>
<p>Warning: with any nightly release there may still be bugs that are not yet fixed.</p>
</div>

</article>


<div>
 Liked this article? Buy me a beer on the Bitcoin Lightning Network
<div id="tippin-button" data-dest="shalzzj"></div>
<script src="https://tippin.me/buttons/tip.js" type="text/javascript"></script>
<br/>
</div>



  <p>Got any questions or comments? Drop me a message on <a href="https:&#x2F;&#x2F;twitter.com&#x2F;shalzzj" rel="nofollow">Twitter @shalzzj</a> or comment below.</p>




<div class="comments" id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https:&#x2F;&#x2F;shaleenjain.com&#x2F;blog&#x2F;vlc-dlna-support-2&#x2F;';
        this.page.identifier = 'blog/vlc-dlna-support-2';
        this.page.title = 'DLNA&#x2F;UPNP casting support in VLC - Part 2';
    };
    var disqus_shortname = 'shalzz';
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        dsq.setAttribute('data-timestamp', +new Date());
        (document.head || document.body).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





    </main>

    
        <footer class="footer">
          <p><small>
            This work is licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            CC BY-SA 4.0</a> license.
          <br/>
          <a href="https://shaleenjain.com/atom.xml">RSS Feed</a> â€¢
          <a href="https://shaleenjain.com/donate/">Support my work</a>!
          </small></p>
        </footer>
    

    
    
        <script data-goatcounter="https://personal.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    
    
  </body>
</html>
